# PASSO 16 - VISUAL ARCHITECTURE

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          EXTERNAL SYSTEMS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   STAYS API          â”‚  â”‚   REDIS              â”‚  â”‚   PostgreSQL â”‚ â”‚
â”‚  â”‚  (Source of Truth)   â”‚  â”‚  (Queue Storage)     â”‚  â”‚   (Local DB) â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚                      â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ GET /reservations    â”‚  â”‚ BullMQ Jobs          â”‚  â”‚ Tables:      â”‚ â”‚
â”‚  â”‚   (updated_since)    â”‚  â”‚ - generatePinQueue   â”‚  â”‚ - users      â”‚ â”‚
â”‚  â”‚                      â”‚  â”‚ - revokePinQueue     â”‚  â”‚ - locks      â”‚ â”‚
â”‚  â”‚ Response: {          â”‚  â”‚                      â”‚  â”‚ - reservations
â”‚  â”‚   reservations: []   â”‚  â”‚ Reconciliation Job   â”‚  â”‚ - credentials
â”‚  â”‚ }                    â”‚  â”‚                      â”‚  â”‚ - reconciliation_logs
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â–²                           â–²                        â–²
â”‚         â”‚                           â”‚                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â”‚                                  â”‚
â”‚         Connection from: ReconciliationService        â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â–²
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                             â”‚
                    â”‚  SERVER.TS STARTUP          â”‚
                    â”‚  registerReconciliationJob()
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APPLICATION LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CRON JOB TRIGGER (*/30 * * * *)                                 â”‚   â”‚
â”‚  â”‚  Every 30 minutes, BullMQ fires the job                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                                     â”‚
â”‚                     â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ReconciliationService.reconcile()                               â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  Step 1: Get lastRunAt from ReconciliationLog                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ SELECT MAX("completedAt") FROM reconciliation_logs          â”‚   â”‚
â”‚  â”‚  â””â”€ If first run: use 24 hours ago                              â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  Step 2: Fetch updates from Stays API                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ Call staysClient.getReservationsUpdatedSince(lastRunAt)    â”‚   â”‚
â”‚  â”‚  â””â”€ Response: Array of StaysReservation objects                 â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  Step 3: Process each reservation                               â”‚   â”‚
â”‚  â”‚  â”œâ”€ For each staysReservation:                                 â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€ Find existing by staysReservationId                    â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€ If NOT found:                                          â”‚   â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€ createReservationFromStays()                       â”‚   â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€ INSERT into reservations table                     â”‚   â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€ scheduleJobs() for PIN generation/revocation      â”‚   â”‚
â”‚  â”‚  â”‚   â”‚   â””â”€ stats.created++                                   â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€ If found:                                              â”‚   â”‚
â”‚  â”‚  â”‚       â”œâ”€ updateReservationFromStays()                       â”‚   â”‚
â”‚  â”‚  â”‚       â”œâ”€ Check: guestName, email, status changed?           â”‚   â”‚
â”‚  â”‚  â”‚       â”œâ”€ If yes: UPDATE reservation                         â”‚   â”‚
â”‚  â”‚  â”‚       â”œâ”€ If status â†’ 'confirmed': reschedule jobs          â”‚   â”‚
â”‚  â”‚  â”‚       â””â”€ stats.updated++ or skip                           â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  Step 4: Cleanup orphaned jobs                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ cleanupOrphanedJobs()                                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ GET all jobs from generatePinQueue + revokePinQueue       â”‚   â”‚
â”‚  â”‚  â”œâ”€ For each job:                                              â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€ Extract reservationId from job.data                    â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€ Find Reservation in DB                                 â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€ If NOT found: job.remove()                             â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€ stats.orphaned++                                       â”‚   â”‚
â”‚  â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  Step 5: Log result                                            â”‚   â”‚
â”‚  â”‚  â”œâ”€ ReconciliationLog.create({                                â”‚   â”‚
â”‚  â”‚  â”‚   status: 'success' or 'failed',                           â”‚   â”‚
â”‚  â”‚  â”‚   fetched, created, updated, orphaned, errors,             â”‚   â”‚
â”‚  â”‚  â”‚   duration: endTime - startTime                            â”‚   â”‚
â”‚  â”‚  â”‚ })                                                          â”‚   â”‚
â”‚  â”‚  â””â”€ Return ReconciliationResult                                â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                                     â”‚
â”‚                     â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  API ENDPOINT: GET /api/admin/reconciliation/status             â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  1. Verify JWT token (admin role)                               â”‚   â”‚
â”‚  â”‚  2. Query ReconciliationLog (latest)                            â”‚   â”‚
â”‚  â”‚  3. Calculate nextRun = lastCompleted + 30 minutes              â”‚   â”‚
â”‚  â”‚  4. Return:                                                     â”‚   â”‚
â”‚  â”‚     {                                                            â”‚   â”‚
â”‚  â”‚       "data": {                                                 â”‚   â”‚
â”‚  â”‚         "lastRun": {...},                                       â”‚   â”‚
â”‚  â”‚         "nextRun": "2024-02-01T11:02:00Z",                     â”‚   â”‚
â”‚  â”‚         "currentStatus": "success",                             â”‚   â”‚
â”‚  â”‚         "schedule": "*/30 * * * *"                             â”‚   â”‚
â”‚  â”‚       }                                                          â”‚   â”‚
â”‚  â”‚     }                                                            â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DASHBOARD / MONITORING                                          â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â”‚  Frontend displays:                                              â”‚   â”‚
â”‚  â”‚  - Last Run: 2024-02-01 10:30:00                                â”‚   â”‚
â”‚  â”‚  - Status: âœ… Success                                            â”‚   â”‚
â”‚  â”‚  - Duration: 2m 15s                                              â”‚   â”‚
â”‚  â”‚  - Stats:                                                        â”‚   â”‚
â”‚  â”‚    â€¢ Fetched: 45 reservations                                   â”‚   â”‚
â”‚  â”‚    â€¢ Created: 3 new                                              â”‚   â”‚
â”‚  â”‚    â€¢ Updated: 12 existing                                        â”‚   â”‚
â”‚  â”‚    â€¢ Orphaned: 0 jobs cleaned                                   â”‚   â”‚
â”‚  â”‚    â€¢ Errors: 0                                                   â”‚   â”‚
â”‚  â”‚  - Next Run: 11:00:00                                            â”‚   â”‚
â”‚  â”‚                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow Diagram

```
TIME: 10:30:00 (Cron triggers)

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Redis: Job Queue Fires  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ BullMQ Worker                â”‚
        â”‚ Picks up: "periodic" job     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ReconciliationService.reconcile()        â”‚
        â”‚                                          â”‚
        â”‚ 1. Query DB:                             â”‚
        â”‚    lastRunAt = 10:00:00 (30 min ago)     â”‚
        â”‚                                          â”‚
        â”‚ 2. Call Stays API:                       â”‚
        â”‚    GET /api/reservations?updated_since= â”‚
        â”‚    10:00:00                              â”‚
        â”‚                                          â”‚
        â”‚    Response:                             â”‚
        â”‚    [                                     â”‚
        â”‚      {                                   â”‚
        â”‚        id: 'stay-123',                   â”‚
        â”‚        accommodation_id: 'acc-1',        â”‚
        â”‚        guest_name: 'John Doe',           â”‚
        â”‚        status: 'confirmed',              â”‚
        â”‚        check_in: '2024-02-05',           â”‚
        â”‚        check_out: '2024-02-08'           â”‚
        â”‚      },                                  â”‚
        â”‚      ... (44 more)                       â”‚
        â”‚    ]                                     â”‚
        â”‚    Total: 45 reservations                â”‚
        â”‚                                          â”‚
        â”‚ 3. For each reservation:                 â”‚
        â”‚                                          â”‚
        â”‚    A. stay-123:                          â”‚
        â”‚       â”œâ”€ Find by staysReservationId      â”‚
        â”‚       â”œâ”€ NOT FOUND                       â”‚
        â”‚       â”œâ”€ â†’ CREATE new reservation        â”‚
        â”‚       â”œâ”€ INSERT into DB                  â”‚
        â”‚       â”œâ”€ scheduleJobs():                 â”‚
        â”‚       â”‚  â”œâ”€ generatePin: delay to        â”‚
        â”‚       â”‚  â”‚  2024-02-05 06:00 (2h before)â”‚
        â”‚       â”‚  â””â”€ revokePin: delay to         â”‚
        â”‚       â”‚     2024-02-09 (24h after)      â”‚
        â”‚       â””â”€ stats.created++                 â”‚
        â”‚                                          â”‚
        â”‚    B. stay-456 (exists, unchanged):      â”‚
        â”‚       â”œâ”€ Find by staysReservationId      â”‚
        â”‚       â”œâ”€ FOUND                           â”‚
        â”‚       â”œâ”€ Compare fields                  â”‚
        â”‚       â”œâ”€ NO CHANGES                      â”‚
        â”‚       â”œâ”€ SKIP update                     â”‚
        â”‚       â””â”€ (no stats increment)            â”‚
        â”‚                                          â”‚
        â”‚    C. stay-789 (exists, changed):        â”‚
        â”‚       â”œâ”€ Find by staysReservationId      â”‚
        â”‚       â”œâ”€ FOUND                           â”‚
        â”‚       â”œâ”€ Compare fields                  â”‚
        â”‚       â”œâ”€ STATUS CHANGED: pendingâ†’confirm â”‚
        â”‚       â”œâ”€ UPDATE reservation              â”‚
        â”‚       â”œâ”€ Reschedule PIN jobs             â”‚
        â”‚       â””â”€ stats.updated++                 â”‚
        â”‚                                          â”‚
        â”‚    ... (42 more similar)                 â”‚
        â”‚                                          â”‚
        â”‚ 4. cleanupOrphanedJobs():                â”‚
        â”‚    â”œâ”€ Query generatePinQueue: 150 jobs   â”‚
        â”‚    â”œâ”€ Query revokePinQueue: 120 jobs     â”‚
        â”‚    â”œâ”€ For each job:                      â”‚
        â”‚    â”‚  â”œâ”€ Find Reservation                â”‚
        â”‚    â”‚  â”œâ”€ Job gen-oldid-1:                â”‚
        â”‚    â”‚  â”‚  â””â”€ Reservation NOT FOUND        â”‚
        â”‚    â”‚  â”‚     â†’ job.remove()               â”‚
        â”‚    â”‚  â””â”€ (0 orphaned found this run)     â”‚
        â”‚    â””â”€ stats.orphaned += 0                â”‚
        â”‚                                          â”‚
        â”‚ 5. ReconciliationLog.create():           â”‚
        â”‚    {                                     â”‚
        â”‚      id: 'uuid-789',                     â”‚
        â”‚      lastRunAt: 10:00:00,                â”‚
        â”‚      startedAt: 10:30:00,                â”‚
        â”‚      completedAt: 10:32:15,              â”‚
        â”‚      duration: 135000 (ms),              â”‚
        â”‚      fetched: 45,                        â”‚
        â”‚      created: 3,                         â”‚
        â”‚      updated: 12,                        â”‚
        â”‚      orphaned: 0,                        â”‚
        â”‚      deleted: 0,                         â”‚
        â”‚      errors: 0,                          â”‚
        â”‚      status: 'success',                  â”‚
        â”‚      message: null                       â”‚
        â”‚    }                                     â”‚
        â”‚                                          â”‚
        â”‚ Return: ReconciliationResult             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ BullMQ Worker Completes      â”‚
        â”‚ Logs: "âœ… Completed"         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Database Updated:                    â”‚
        â”‚ - 3 new reservations                 â”‚
        â”‚ - 12 existing updated                â”‚
        â”‚ - 6 PIN generation jobs scheduled   â”‚
        â”‚ - 1 ReconciliationLog entry created â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ API Ready: /api/admin/reconciliation/ â”‚
        â”‚ status can return fresh stats        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NEXT EXECUTION: 11:00:00 (30 min later, auto-scheduled)
```

---

## ğŸ“Š PIN Job Scheduling Timeline

```
RESERVATION: Check-in 2024-02-05 10:00, Check-out 2024-02-08 14:00

Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2024-02-05 08:00  â—„â”€â”€â”€ generatePin Job TRIGGERS
                         Action: Create credential (PIN)
                         Status: isActive = true, expiresAt = 2024-02-05 10:00
                         Duration: 2 hours before check-in

2024-02-05 10:00  â—„â”€â”€â”€ CHECK-IN TIME
                         Guest enters with PIN

2024-02-08 14:00  â—„â”€â”€â”€ CHECK-OUT TIME
                         Guest leaves

2024-02-09 14:00  â—„â”€â”€â”€ revokePin Job TRIGGERS
                         Action: Revoke credential (PIN)
                         Status: revokedAt = 2024-02-09 14:00
                         Duration: 24 hours after check-out


Job Details:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

generatePin Job:
  - Job ID: gen-res-123456
  - Queue: generatePinQueue
  - Delay: (checkIn - now - 2h) milliseconds
  - Data: { reservationId, accommodationId, lockId }
  - On execution: Create new Credential with PIN

revokePin Job:
  - Job ID: rev-res-123456
  - Queue: revokePinQueue
  - Delay: (checkOut - now + 24h) milliseconds
  - Data: { reservationId, credentialId }
  - On execution: Update Credential.revokedAt = NOW()
```

---

## ğŸ§¹ Orphaned Job Cleanup

```
SCENARIO: PIN jobs exist but reservation was deleted

BEFORE CLEANUP:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Redis (BullMQ):
  â”œâ”€ gen-res-old-123 (generatePin job)
  â”œâ”€ gen-res-old-456 (generatePin job)
  â”œâ”€ rev-res-valid-1 (revokePin job)
  â””â”€ ... (many more)

PostgreSQL:
  reservations table:
    â”œâ”€ res-valid-1 (ACTIVE)
    â”œâ”€ res-valid-2 (ACTIVE)
    â””â”€ (res-old-123 and res-old-456 DELETED)


CLEANUP PROCESS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Get all jobs from generatePinQueue
   â†’ [gen-res-old-123, gen-res-old-456, ...]

2. Get all jobs from revokePinQueue
   â†’ [rev-res-valid-1, ...]

3. For each job:
   â”œâ”€ Extract reservationId from job.data
   â””â”€ Query: SELECT id FROM reservations WHERE id = reservationId
   
   a) Job: gen-res-old-123
      â””â”€ Query returns: NULL (reservation doesn't exist)
         â†’ job.remove()  âœ“ DELETED
      
   b) Job: gen-res-old-456
      â””â”€ Query returns: NULL
         â†’ job.remove()  âœ“ DELETED
      
   c) Job: rev-res-valid-1
      â””â”€ Query returns: res-valid-1 (reservation exists)
         â†’ job.keep()  (no action)

RESULT:
â”€â”€â”€â”€â”€â”€
stats.orphaned = 2
Redis now clean: orphaned jobs removed
```

---

## ğŸš€ Error Scenarios

```
SCENARIO 1: Stays API Unavailable
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

reconcile() call
  â†“
Call staysClient.getReservationsUpdatedSince()
  â†“
âŒ Network error / API down
  â†“
Catch exception in try-catch
  â†“
ReconciliationLog.create({
  status: 'failed',
  error: 'Failed to fetch from Stays API',
  fetched: 0, created: 0, updated: 0,
  errors: 1
})
  â†“
Job retry logic triggered
  - Retry 1: after 2s
  - Retry 2: after 4s (exponential backoff)
  - Retry 3: after 8s
  â†“
If all retries fail:
  - Next execution: in 30 minutes (normal schedule)


SCENARIO 2: Partial Failure (1 of 45 reservations fails)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

For each staysReservation:
  - 44 succeed: created/updated
  - 1 fails: processStaysReservation() throws
    â””â”€ Caught in try-catch (inner)
    â””â”€ stats.errors++
    â””â”€ Continue to next reservation
    
Final result:
  {
    success: true,  (overall still succeeds)
    stats: {
      fetched: 45,
      created: 44,
      errors: 1,
      ...
    },
    message: null
  }
  
ReconciliationLog:
  status: 'success'  (partial success is acceptable)
  errors: 1


SCENARIO 3: Orphaned Cleanup Fails
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cleanupOrphanedJobs() throws exception
  â†“
Caught in try-catch (main reconcile)
  â†“
stats.orphaned remains 0 (not incremented)
stats.errors++
  â†“
ReconciliationLog.create({
  status: 'success',  (non-blocking)
  message: 'Partial cleanup failed, but processing succeeded'
})
  â†“
Next execution will retry cleanup
```

---

## ğŸ“ˆ Metrics & Monitoring

```
ReconciliationLog Stats Example:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

id                  | 87a3f4e9-1b2c-4d5e-8f9a-0b1c2d3e4f5a
lastRunAt           | 2024-02-01 10:00:00
startedAt           | 2024-02-01 10:30:00
completedAt         | 2024-02-01 10:32:15
duration            | 135000 (2 minutes 15 seconds)
fetched             | 45
created             | 3
updated             | 12
orphaned            | 0
deleted             | 0
errors              | 0
status              | success
message             | NULL

Dashboard Calculation:
  âœ“ Success rate: 100% (no errors)
  âœ“ Throughput: 45 reservations / 135s = 0.33 res/sec
  âœ“ Processing time: 135s for 45 items = 3s per item average
  âœ“ Impact: 3 new, 12 updated, 0 orphaned cleaned
  âœ“ Next execution: 11:00:00 (exactly 30 min later)
```

---

## ğŸ¯ Summary

```
PASSO 16 Implementation: Three main components

1. ReconciliationService (Library)
   â””â”€ Contains all sync logic
   â””â”€ Called by job runner
   â””â”€ Returns stats + result

2. reconciliation.job (BullMQ Worker)
   â””â”€ Scheduled every 30 minutes
   â””â”€ Calls ReconciliationService.reconcile()
   â””â”€ Handles retries and errors

3. ReconciliationLog (Audit Trail)
   â””â”€ Records every execution
   â””â”€ Tracks stats for monitoring
   â””â”€ Enables visibility + debugging

Result: Fully synced, audited, resilient system âœ…
```
